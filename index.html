<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur Texte-Voix Naturelle avec VoiceRSS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            padding: 40px;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.8rem;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .input-section, .controls-section, .voices-section, .apikey-section {
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .api-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .api-input-group {
            flex: 1;
            min-width: 300px;
        }

        .api-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-note {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .api-note a {
            color: #3498db;
            text-decoration: none;
        }

        .api-note a:hover {
            text-decoration: underline;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stats span {
            background-color: #f8f9fa;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }

        .value-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .voices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ecf0f1;
            border-radius: 10px;
        }

        .voice-option {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .voice-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .voice-option.selected {
            border-color: #2ecc71;
            background-color: #e8f6f3;
        }

        .voice-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .voice-lang {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .voice-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background-color: #3498db;
            color: white;
            margin-right: 5px;
        }

        .voice-type.local {
            background-color: #27ae60;
        }

        .natural-badge {
            background-color: #f39c12;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            display: inline-block;
            margin-left: 5px;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
        }

        .play-btn {
            background: linear-gradient(90deg, #2ecc71, #1abc9c);
            color: white;
        }

        .play-btn:hover {
            background: linear-gradient(90deg, #27ae60, #16a085);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .stop-btn {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
        }

        .stop-btn:hover {
            background: linear-gradient(90deg, #c0392b, #a93226);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .pause-btn {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
        }

        .pause-btn:hover {
            background: linear-gradient(90deg, #2980b9, #1c5a7d);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .reset-btn {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            color: white;
        }

        .reset-btn:hover {
            background: linear-gradient(90deg, #e67e22, #d35400);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .download-btn {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(90deg, #8e44ad, #7d3c98);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .status.ready {
            background-color: #e8f6f3;
            color: #27ae60;
        }

        .status.speaking {
            background-color: #ebf5fb;
            color: #2980b9;
        }

        .status.paused {
            background-color: #fef9e7;
            color: #f39c12;
        }

        .status.stopped {
            background-color: #fbebee;
            color: #e74c3c;
        }

        .status.processing {
            background-color: #f4ecf7;
            color: #9b59b6;
        }

        .example-text {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
            cursor: pointer;
            text-decoration: underline;
            display: inline-block;
        }

        .example-text:hover {
            color: #3498db;
        }

        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-left: 20px;
            color: #555;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            width: 100%;
        }

        .engine-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .engine-option {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .engine-option:hover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }

        .engine-option.selected {
            border-color: #2ecc71;
            background-color: #e8f6f3;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background-color: #fbebee;
            color: #e74c3c;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .success-message {
            background-color: #e8f6f3;
            color: #27ae60;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .voice-search {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .voice-search:focus {
            outline: none;
            border-color: #3498db;
        }

        .voice-count {
            margin-bottom: 10px;
            color: #7f8c8d;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .voice-option, .api-input-group {
                min-width: 100%;
            }
            
            button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Convertisseur Texte-Voix Naturelle</h1>
            <p class="subtitle">‚ú® Retrouvez les voix naturelles du premier code - Fran√ßais et Anglais en priorit√©</p>
        </header>

        <section class="apikey-section">
            <h2>Configuration VoiceRSS</h2>
            <div class="engine-selector">
                <div class="engine-option selected" id="engineBrowser">Moteur Navigateur</div>
                <div class="engine-option" id="engineVoiceRSS">VoiceRSS (T√©l√©chargement MP3)</div>
            </div>
            
            <div id="voiceRSSConfig" class="hidden">
                <div class="api-container">
                    <div class="api-input-group">
                        <label for="apiKey">Cl√© API VoiceRSS</label>
                        <input type="text" id="apiKey" placeholder="Entrez votre cl√© API VoiceRSS" value="a14541231b764962942cac8697f2ca29">
                    </div>
                </div>
                <p class="api-note">
                    <strong>‚úÖ Votre cl√© API est d√©j√† configur√©e !</strong> La version gratuite offre 350 requ√™tes par jour.
                </p>
            </div>
        </section>

        <section class="input-section">
            <h2>Texte √† convertir</h2>
            <textarea id="textInput" placeholder="√âcrivez ou collez votre texte ici...">Bonjour ! Je suis votre assistant vocal. Je peux lire votre texte avec une voix naturelle, comme dans le premier code.</textarea>
            <div class="stats">
                <span id="charCount">0 caract√®res</span>
                <span id="wordCount">0 mots</span>
                <span id="sentenceCount">0 phrases</span>
                <span id="audioSize">0 KB</span>
            </div>
            <p class="example-text" id="loadExample">Charger un exemple de texte</p>
        </section>

        <section class="controls-section">
            <h2>Param√®tres de la voix</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="rate">Vitesse de parole</label>
                    <div class="slider-container">
                        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="rateValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="pitch">Ton de la voix</label>
                    <div class="slider-container">
                        <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1">
                        <span class="value-display" id="pitchValue">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="volume">Volume</label>
                    <div class="slider-container">
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
                        <span class="value-display" id="volumeValue">1.0</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="voices-section">
            <h2>S√©lectionnez une voix</h2>
            <input type="text" id="voiceSearch" class="voice-search" placeholder="üîç Rechercher une voix...">
            <div class="voice-count" id="voiceCount">Chargement des voix...</div>
            <div class="voices-container" id="voicesContainer">
                <!-- Les options de voix seront ajout√©es dynamiquement -->
            </div>
        </section>

        <div class="buttons">
            <button id="playBtn" class="play-btn">
                <span>‚ñ∂ Lire le texte</span>
            </button>
            <button id="pauseBtn" class="pause-btn" disabled>
                <span>‚è∏ Pause</span>
            </button>
            <button id="resumeBtn" class="pause-btn" disabled>
                <span>‚ñ∂ Reprendre</span>
            </button>
            <button id="stopBtn" class="stop-btn" disabled>
                <span>‚èπ Arr√™ter</span>
            </button>
            <button id="downloadBtn" class="download-btn" disabled>
                <span>‚¨á T√©l√©charger MP3</span>
            </button>
            <button id="resetBtn" class="reset-btn">
                <span>‚Ü∫ R√©initialiser</span>
            </button>
        </div>

        <div class="status ready" id="status">
            Pr√™t √† convertir le texte en voix
        </div>

        <div id="apiMessage"></div>
    </div>

    <footer>
        <p>‚ú® Version avec les m√™mes voix que le premier code - Google, Microsoft, fran√ßais et anglais</p>
    </footer>

    <script>
        // √âl√©ments DOM
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const sentenceCount = document.getElementById('sentenceCount');
        const audioSize = document.getElementById('audioSize');
        const rateSlider = document.getElementById('rate');
        const rateValue = document.getElementById('rateValue');
        const pitchSlider = document.getElementById('pitch');
        const pitchValue = document.getElementById('pitchValue');
        const volumeSlider = document.getElementById('volume');
        const volumeValue = document.getElementById('volumeValue');
        const voicesContainer = document.getElementById('voicesContainer');
        const voiceSearch = document.getElementById('voiceSearch');
        const voiceCount = document.getElementById('voiceCount');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const status = document.getElementById('status');
        const loadExample = document.getElementById('loadExample');
        const apiKeyInput = document.getElementById('apiKey');
        const voiceRSSConfig = document.getElementById('voiceRSSConfig');
        const engineBrowser = document.getElementById('engineBrowser');
        const engineVoiceRSS = document.getElementById('engineVoiceRSS');
        const apiMessage = document.getElementById('apiMessage');

        // Variables globales
        let synth = window.speechSynthesis;
        let allVoices = [];
        let displayedVoices = [];
        let selectedVoice = null;
        let isPlaying = false;
        let isPaused = false;
        let currentUtterance = null;
        let audioBlob = null;
        let audioUrl = null;
        let currentEngine = 'browser';
        let audioElement = null;

        // Configuration des moteurs
        engineBrowser.addEventListener('click', () => {
            engineBrowser.classList.add('selected');
            engineVoiceRSS.classList.remove('selected');
            voiceRSSConfig.classList.add('hidden');
            currentEngine = 'browser';
            updateButtons();
            status.textContent = 'Moteur navigateur activ√©';
            status.className = 'status ready';
            clearApiMessage();
        });

        engineVoiceRSS.addEventListener('click', () => {
            engineBrowser.classList.remove('selected');
            engineVoiceRSS.classList.add('selected');
            voiceRSSConfig.classList.remove('hidden');
            currentEngine = 'voicerss';
            updateButtons();
            status.textContent = 'VoiceRSS activ√©';
            status.className = 'status ready';
            clearApiMessage();
        });

        // Fonctions d'affichage
        function showApiMessage(message, type = 'error') {
            clearApiMessage();
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            apiMessage.appendChild(messageDiv);
        }

        function clearApiMessage() {
            apiMessage.innerHTML = '';
        }

        function updateStatus(text, className) {
            status.textContent = text;
            status.className = `status ${className}`;
        }

        // Mettre √† jour les statistiques
        function updateTextStats() {
            const text = textInput.value;
            charCount.textContent = `${text.length} caract√®res`;
            
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            wordCount.textContent = `${words} mots`;
            
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
            sentenceCount.textContent = `${sentences} phrases`;
            
            const estimatedSize = Math.round(text.length * 0.05);
            audioSize.textContent = `${estimatedSize} KB estim√©s`;
        }

        // Sliders
        rateSlider.addEventListener('input', () => rateValue.textContent = rateSlider.value);
        pitchSlider.addEventListener('input', () => pitchValue.textContent = pitchSlider.value);
        volumeSlider.addEventListener('input', () => volumeValue.textContent = volumeSlider.value);

        // ‚úÖ Fonction pour identifier les voix naturelles du premier code
        function isNaturalVoice(voiceName, voiceLang) {
            const naturalVoices = [
                // Voix fran√ßaises
                'google fran√ßais',
                'microsoft julie',
                'microsoft hortense',
                'fr-fr-standard',
                'fr-fr-wavenet',
                // Voix anglaises UK
                'google uk english female',
                'google uk english male',
                'microsoft susan',
                'microsoft hazel',
                // Voix am√©ricaines
                'google us english',
                'microsoft zira',
                'microsoft david',
                // Mots-cl√©s g√©n√©riques
                'google',
                'microsoft',
                'wavenet',
                'standard'
            ];
            
            const nameLower = voiceName.toLowerCase();
            const langLower = voiceLang.toLowerCase();
            
            // Les voix fran√ßaises sont prioritaires
            if (langLower.startsWith('fr')) {
                return true;
            }
            
            // Les voix anglaises UK et US
            if (langLower.startsWith('en')) {
                return true;
            }
            
            // V√©rifier les mots-cl√©s
            for (const pattern of naturalVoices) {
                if (nameLower.includes(pattern)) {
                    return true;
                }
            }
            
            return false;
        }

        // ‚úÖ Fonction pour trier les voix comme dans le premier code
        function sortVoicesLikeFirstCode(voices) {
            return voices.sort((a, b) => {
                // 1. Voix fran√ßaises d'abord
                const aIsFrench = a.lang.startsWith('fr');
                const bIsFrench = b.lang.startsWith('fr');
                if (aIsFrench && !bIsFrench) return -1;
                if (!aIsFrench && bIsFrench) return 1;
                
                // 2. Voix anglaises ensuite
                const aIsEnglish = a.lang.startsWith('en');
                const bIsEnglish = b.lang.startsWith('en');
                if (aIsEnglish && !bIsEnglish && !aIsFrench) return -1;
                if (!aIsEnglish && bIsEnglish && !bIsFrench) return 1;
                
                // 3. Google avant Microsoft
                const aIsGoogle = a.name.toLowerCase().includes('google');
                const bIsGoogle = b.name.toLowerCase().includes('google');
                if (aIsGoogle && !bIsGoogle) return -1;
                if (!aIsGoogle && bIsGoogle) return 1;
                
                // 4. Microsoft ensuite
                const aIsMicrosoft = a.name.toLowerCase().includes('microsoft');
                const bIsMicrosoft = b.name.toLowerCase().includes('microsoft');
                if (aIsMicrosoft && !bIsMicrosoft) return -1;
                if (!aIsMicrosoft && bIsMicrosoft) return 1;
                
                // 5. Wavenet avant Standard
                const aIsWavenet = a.name.toLowerCase().includes('wavenet');
                const bIsWavenet = b.name.toLowerCase().includes('wavenet');
                if (aIsWavenet && !bIsWavenet) return -1;
                if (!aIsWavenet && bIsWavenet) return 1;
                
                // 6. Ensuite tri alphab√©tique
                if (a.lang < b.lang) return -1;
                if (a.lang > b.lang) return 1;
                if (a.name < b.name) return -1;
                if (a.name > b.name) return 1;
                return 0;
            });
        }

        // Afficher les voix
        function displayVoices() {
            voicesContainer.innerHTML = '';
            
            if (displayedVoices.length === 0) {
                voicesContainer.innerHTML = '<p>Aucune voix disponible.</p>';
                voiceCount.textContent = '0 voix disponible';
                return;
            }
            
            voiceCount.textContent = `${displayedVoices.length} voix disponible${displayedVoices.length > 1 ? 's' : ''}`;
            
            displayedVoices.forEach((voice) => {
                const voiceOption = document.createElement('div');
                voiceOption.className = 'voice-option';
                
                if (selectedVoice && selectedVoice.name === voice.name && selectedVoice.lang === voice.lang) {
                    voiceOption.classList.add('selected');
                }
                
                const voiceType = voice.localService ? 'Locale' : 'R√©seau';
                const voiceTypeClass = voice.localService ? 'local' : '';
                const isNatural = isNaturalVoice(voice.name, voice.lang);
                
                voiceOption.innerHTML = `
                    <div class="voice-name">
                        ${voice.name}
                        ${isNatural ? '‚ú®' : ''}
                        ${voice.lang.startsWith('fr') ? 'üá´üá∑' : voice.lang.startsWith('en') ? 'üá¨üáß' : ''}
                    </div>
                    <div class="voice-lang">${voice.lang}</div>
                    <span class="voice-type ${voiceTypeClass}">${voiceType}</span>
                `;
                
                voiceOption.addEventListener('click', () => {
                    document.querySelectorAll('.voice-option').forEach(opt => opt.classList.remove('selected'));
                    voiceOption.classList.add('selected');
                    selectedVoice = voice;
                    showApiMessage(`‚úÖ Voix s√©lectionn√©e : ${voice.name}`, 'success');
                });
                
                voicesContainer.appendChild(voiceOption);
            });
        }

        // Filtrer les voix
        function filterVoices() {
            const searchTerm = voiceSearch.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                displayedVoices = [...allVoices];
            } else {
                displayedVoices = allVoices.filter(voice => 
                    voice.name.toLowerCase().includes(searchTerm) ||
                    voice.lang.toLowerCase().includes(searchTerm)
                );
            }
            
            displayVoices();
        }

        // ‚úÖ Charger les voix comme dans le premier code
        function loadVoices() {
            const newVoices = synth.getVoices();
            
            if (newVoices.length > 0) {
                // S√©parer les voix naturelles
                const naturalVoices = [];
                const otherVoices = [];
                
                newVoices.forEach(voice => {
                    if (isNaturalVoice(voice.name, voice.lang)) {
                        naturalVoices.push(voice);
                    } else {
                        otherVoices.push(voice);
                    }
                });
                
                // Trier les voix naturelles comme dans le premier code
                const sortedNatural = sortVoicesLikeFirstCode(naturalVoices);
                const sortedOther = sortVoicesLikeFirstCode(otherVoices);
                
                // Combiner : naturelles d'abord, puis les autres
                allVoices = [...sortedNatural, ...sortedOther];
                displayedVoices = [...allVoices];
                
                // S√©lectionner la premi√®re voix fran√ßaise si disponible
                const frenchVoice = allVoices.find(v => v.lang.startsWith('fr'));
                if (frenchVoice) {
                    selectedVoice = frenchVoice;
                } else if (allVoices.length > 0) {
                    selectedVoice = allVoices[0];
                }
                
                displayVoices();
                showApiMessage(`‚úÖ ${naturalVoices.length} voix naturelles charg√©es`, 'success');
            }
        }

        // Initialiser les voix
        if (typeof speechSynthesis !== 'undefined') {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        // Recherche
        voiceSearch.addEventListener('input', filterVoices);

        // Mettre √† jour les stats
        textInput.addEventListener('input', updateTextStats);
        updateTextStats();

        // VoiceRSS
        async function speakWithVoiceRSS() {
            const text = textInput.value.trim();
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                showApiMessage('Veuillez entrer votre cl√© API VoiceRSS.');
                return;
            }
            
            if (text === '') {
                showApiMessage('Veuillez saisir du texte √† lire.');
                return;
            }
            
            playBtn.disabled = true;
            updateStatus('G√©n√©ration audio...', 'processing');
            clearApiMessage();
            
            try {
                const params = new URLSearchParams({
                    key: apiKey,
                    src: text,
                    hl: 'fr-fr',
                    v: 'Louis',
                    r: rateSlider.value,
                    c: 'MP3',
                    f: '44khz_16bit_stereo'
                });
                
                const response = await fetch(`https://api.voicerss.org/?${params.toString()}`);
                const responseText = await response.text();
                
                if (responseText.startsWith('ERROR')) {
                    throw new Error(responseText);
                }
                
                const audioData = new Blob([responseText], { type: 'audio/mpeg' });
                audioBlob = audioData;
                
                if (audioUrl) URL.revokeObjectURL(audioUrl);
                audioUrl = URL.createObjectURL(audioBlob);
                
                if (!audioElement) audioElement = new Audio();
                audioElement.src = audioUrl;
                audioElement.volume = parseFloat(volumeSlider.value);
                
                audioElement.onplay = () => {
                    isPlaying = true;
                    isPaused = false;
                    updateButtons();
                    updateStatus('Lecture en cours...', 'speaking');
                };
                
                audioElement.onended = () => {
                    isPlaying = false;
                    isPaused = false;
                    updateButtons();
                    updateStatus('Lecture termin√©e', 'ready');
                    showApiMessage('Audio g√©n√©r√© !', 'success');
                };
                
                downloadBtn.disabled = false;
                await audioElement.play();
                playBtn.disabled = false;
                
            } catch (error) {
                showApiMessage(`Erreur: ${error.message}`, 'error');
                updateStatus('Erreur', 'error');
                playBtn.disabled = false;
            }
        }

        // Synth√®se navigateur
        function speakWithBrowser() {
            const text = textInput.value.trim();
            
            if (text === '') {
                showApiMessage('Veuillez saisir du texte √† lire.', 'error');
                return;
            }
            
            if (!selectedVoice && allVoices.length > 0) {
                selectedVoice = allVoices[0];
                showApiMessage('Utilisation de la premi√®re voix.', 'warning');
            }
            
            if (!selectedVoice) {
                showApiMessage('Aucune voix disponible.', 'error');
                return;
            }
            
            if (synth.speaking) synth.cancel();
            
            try {
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.voice = selectedVoice;
                currentUtterance.rate = parseFloat(rateSlider.value);
                currentUtterance.pitch = parseFloat(pitchSlider.value);
                currentUtterance.volume = parseFloat(volumeSlider.value);
                
                currentUtterance.onstart = () => {
                    isPlaying = true;
                    isPaused = false;
                    updateButtons();
                    updateStatus(`Lecture avec ${selectedVoice.name}...`, 'speaking');
                };
                
                currentUtterance.onend = () => {
                    isPlaying = false;
                    isPaused = false;
                    updateButtons();
                    updateStatus('Lecture termin√©e', 'ready');
                };
                
                currentUtterance.onerror = () => {
                    isPlaying = false;
                    isPaused = false;
                    updateButtons();
                    updateStatus('Erreur', 'error');
                    showApiMessage('Erreur de synth√®se', 'error');
                };
                
                currentUtterance.onpause = () => {
                    isPaused = true;
                    updateButtons();
                    updateStatus('Pause', 'paused');
                };
                
                currentUtterance.onresume = () => {
                    isPaused = false;
                    updateButtons();
                    updateStatus('Reprise', 'speaking');
                };
                
                synth.speak(currentUtterance);
                
            } catch (error) {
                showApiMessage('Erreur', 'error');
                updateStatus('Erreur', 'error');
                updateButtons();
            }
        }

        // Gestionnaires d'√©v√©nements
        playBtn.addEventListener('click', () => {
            if (isPlaying && !isPaused) return;
            currentEngine === 'voicerss' ? speakWithVoiceRSS() : speakWithBrowser();
        });

        pauseBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement && isPlaying && !isPaused) audioElement.pause();
            } else {
                if (isPlaying && !isPaused) synth.pause();
            }
        });

        resumeBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement && isPlaying && isPaused) audioElement.play();
            } else {
                if (isPlaying && isPaused) synth.resume();
            }
        });

        stopBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                }
            } else {
                synth.cancel();
            }
            isPlaying = false;
            isPaused = false;
            updateButtons();
            updateStatus('Arr√™t√©', 'stopped');
        });

        downloadBtn.addEventListener('click', function() {
            if (!audioBlob) {
                showApiMessage('Aucun fichier √† t√©l√©charger.', 'error');
                return;
            }
            
            const fileName = `audio_${Date.now()}.mp3`;
            const downloadLink = document.createElement('a');
            downloadLink.href = audioUrl;
            downloadLink.download = fileName;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            setTimeout(() => document.body.removeChild(downloadLink), 100);
            showApiMessage(`T√©l√©chargement: ${fileName}`, 'success');
        });

        resetBtn.addEventListener('click', () => {
            if (currentEngine === 'voicerss') {
                if (audioElement) {
                    audioElement.pause();
                    audioElement.src = '';
                }
                if (audioUrl) {
                    URL.revokeObjectURL(audioUrl);
                    audioUrl = null;
                }
                audioBlob = null;
            } else {
                synth.cancel();
            }
            
            isPlaying = false;
            isPaused = false;
            
            rateSlider.value = 1;
            rateValue.textContent = '1.0';
            pitchSlider.value = 1;
            pitchValue.textContent = '1.0';
            volumeSlider.value = 1;
            volumeValue.textContent = '1.0';
            
            textInput.value = '';
            updateTextStats();
            
            voiceSearch.value = '';
            
            if (allVoices.length > 0) {
                const frenchVoice = allVoices.find(v => v.lang.startsWith('fr'));
                selectedVoice = frenchVoice || allVoices[0];
                filterVoices();
            }
            
            downloadBtn.disabled = true;
            updateButtons();
            updateStatus('R√©initialis√©', 'ready');
            clearApiMessage();
            showApiMessage('‚úÖ R√©initialis√©', 'success');
        });

        loadExample.addEventListener('click', () => {
            textInput.value = `La synth√®se vocale du premier code avec les voix naturelles.

Voici les voix que vous retrouvez :
- Google Fran√ßais
- Microsoft Julie
- Microsoft Hortense
- Google UK English Female
- Google UK English Male
- Microsoft Susan
- Microsoft Hazel
- Google US English
- Microsoft Zira
- Microsoft David

Toutes ces voix sont maintenant disponibles et mises en avant.`;
            updateTextStats();
            showApiMessage('üìã Exemple charg√©', 'success');
        });

        function updateButtons() {
            const isVoiceRSS = currentEngine === 'voicerss';
            
            playBtn.disabled = (isPlaying && !isPaused) || (isVoiceRSS && !apiKeyInput.value.trim());
            pauseBtn.disabled = !isPlaying || isPaused;
            resumeBtn.disabled = !isPlaying || !isPaused;
            stopBtn.disabled = !isPlaying;
            
            if (isVoiceRSS) {
                downloadBtn.disabled = !audioBlob || isPlaying;
            } else {
                downloadBtn.disabled = true;
            }
        }

        // Initialisation
        window.addEventListener('load', () => {
            if (apiKeyInput.value.trim()) {
                showApiMessage('‚úÖ Cl√© API VoiceRSS d√©tect√©e', 'success');
            }
            updateButtons();
        });

        updateButtons();
    </script>
</body>
</html>